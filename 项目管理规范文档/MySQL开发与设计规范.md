## 【目的】

规范开发人员进行数据库的设计与开发，提高SQL脚本的可读性、质量和性能；

## 【对象】

服务器开发人员、运维人员、DBA

## 【一、基础规范】

1.【强制】必须使用InnoDB存储引擎。

2.【强制】创建数据库实例及数据库时需要指定其字符集为UTF8mb4。

3.【强制】必须使用UTF8mb4字符集(如果需要存储emoj表情，必须使用UTF8mb4—这一点是要特别注意的，开发人员在设计的时候要评估好某个字段
是否后期有可能存储emoj表情)。

3.1【推荐】在建表语句中 除非必要 不要指定字符集和排序规则 系统默认即可.
![null](http://47.105.48.92:8181/uploads/mindoc/images/m_60968309267b8f93c10ce2d39f0dff7c_r.png)
4.【强制】数据表、数据字段必须加入中文注释。

5.【强制】库名、表名、字段名全部采用小写字母，使用下划线分割，禁止使用MySql保留关键字。（MySQL 5.7 Keywords and Reserved Words）

6.【强制】应用程序禁止使用超级权限的账号访问数据库，安全第一。
原则上 开放给应用程序的账号只能具有SELECT、UPDATE、INSERT权限。

7.【推荐】使用域名而不是IP的方式连接和访问数据库。

## 【二、设计规范】

1.【强制】禁止使用外键，如果有外键完整性约束，需要应用程序控制。
说明：外键会导致表与表之间耦合，update与delete操作都会涉及相关联的表，十分影响sql的性能，甚至会造成死锁。高并发情况下容易影响数
据库性能。

2.【强制】必须有主键，强制使用UNSIGNED自增列作为主键，推荐字符类型使用bigint类型。
说明：
(1)主键递增，数据行写入可以提高插入性能，可以避免page分裂，减少表碎片提升空间和内存的使用。
(2)主键要选择较短的数据类型，Innodb引擎普通索引都会保存主键的值，较短的数据类型可以有效的减少索引的磁盘空间，提高索引的缓存效
率。
(3)无主键的表删除，在row模式的主从架构，会导致备库夯住，主从不同步。

3.【强制】所有表必须有创建时间（create_time）更新时间（update_time）两个字段
| create_time | datetime | 创建时间 | 否 | CURRENT_TIMESTAMP |
| ———— | ———— | ———— | ———— | ———— |
| update_time | datetime | 更新时间 | 否 | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

4.【推荐】拒绝多表关联查询，转成单表查询。

5.【推荐】合理的数据冗余。
说明：为了减少表关联，提高效率，可以适当牺牲范式设计

6.【推荐】字符串转为数值进行存储。
说明：数值类型占用较小的存储空间，较少磁盘IO，查询效率较高。
正例： IP地址字段使用INT类型而不是CHAR(15)进行存储

7.【强制】避免使用NULL字段，并且提供默认值，使用0、空串或特殊字符代表NULL。
说明：NULL字段很难查询优化、索引需要额外空间、复合索引无效 以及唯一索引校验失效,在进行COUNT计数时 IS NULL字段不被计算在内
使得计算结果不准确
正例： num NOT NULL DEFAULT 0 / DEFAULT ‘’
反例：num DEFAULT NULL

8.【强制】禁止使用ENUM，可使用TINYINT代替
当字段中某个数值所代表的含义发生变更时 需要及时更新注释信息

9.【强制】性别字段(gender)使用VARCHAR(6)类型: 男性(male)、 女性(female)

10.【推荐】慎用TEXT/BLOB这些大字段。
说明：会浪费更多的磁盘和内存空间，非必要的大量的大字段查询会淘汰掉热数据，导致内存命中率急剧降低，影响数据库性能。

11.【推荐】金额 存储为 分 int类型

12.【推荐】使用UNSIGNED类型存储非负整数。
说明 : 无符号类型字段的存储范围更大
如 : INT类型有符号的存储范围是-2147483648~~2147483647 无符号的存储范围是0~~4294967295

13.【强制】货币金额字段统一转换成整型，避免使用decimal类型。

14.【推荐】使用VARBINARY存储大小写敏感的变长字符串或二进制内容。
说明 : 需要注意的是’VARBINARY(M)’类型中的’M’与VARCHAR(M)的概念是不同的.
VARBINARY(M)中的M所代表的是字节长度而VARCHAR(M)中的M指的是字符长度

15.【推荐】合理使用日期类型
说明：DATETIME和TIMESTAMP都是精确到秒，优先选择DATETIME. TIMESTAMP4个字节，DATETIME8个字节;
同时5.6版本之后TIMESTAMP和DATETIME都具有自动更新的特性，但需注意TIMESTAMP的日期范围是1970到2038。

16.【强制】合理使用索引。
说明：
(1)索引能提高查询效率，但会影响更新效率。能不建索引的不要建，必须建索引的则必须建。
(2)禁止在更新十分频繁、区分度不高的属性上建立索引，例如‘性别’字段不适合建立索引，其性能和接近于全部扫描。
(3)单表索引数量不超过6个，索引字段数不超过5个，避免冗余索引。
(4)索引字段不能为NULL。
(5)禁止在索引列上进行数学运行和函数运行，否则导致索引失效
(6)建立组合索引，必须把区分度高的字段放在前面，能够更加有效的过滤数据。
区分度计算 :COUNT(DISTINCT LEFT(列名, 索引长度)) / COUNT(*)
(7)合理使用覆盖索引减少磁盘IO，能大大提高查询性能。

17.【推荐】读写分离，
说明：应用在设计之初就考虑读写分离，有利于后期快速扩容

18.【推荐】冷热分离，将大字段、访问频率低的字段拆分到单独的表中存储，分离冷热数据。
说明：有利于有效利用缓存，防止读入无用的冷数据，较少磁盘IO，同时保证热数据常驻内存提高缓存命中率。

19.【推荐】数据归档，根据数据的使用频繁度，对大表定期分库归档。

20.【强制】将text字段、varchar( > 2730)字段拆分到单独的表中存储 缩小主表的体积 提高表数据存取的性能
说明：关于提高数据库磁盘空间利用率的方案

21.【强制】枚举字段注释格式遵循[正常注释]|ENUM-[值]:[注释],[值]:[注释]…，如“是否有效|ENUM-1:是,0:否”

22.【强制】逻辑外键字段注释格式遵循[正常注释]|FK-[表名].[字段名]，如“学校ID|FK-t_school.id”

## 【三、开发规范】

1.【强制】禁止在数据库中存储明文密码。
说明：采用加密字符串存储密码，并保证密码不可解密，同时采用随机字符串加盐保证密码安全。

2.【强制】禁止使用存储过程、视图、触发器、事件、自定义函数
说明：数据库擅长存储与索引，禁止在数据库做运算。高并发大数据的互联网业务，架构设计思路是“解放数据库CPU，将计算转移到服务层”。
反例：select id from t where age +1 = 10

3.【强制】禁止存储大文件或者大照片。
说明：大文件和照片存储在文件系统，数据库里存URI

4.【推荐】拒绝3B: 大Sql、大事务、大批量
说明：在高并发、高负载的情况下，任何一个大的操作都有拖垮整个数据库的风险，建议sql语句尽量简单、大语句拆成小语句，分批多次执行，
缩短事务时间，减少锁等待的时间

5.【推荐】单表最大数据量控制在1000W左右，字段数控制在20-50个左右。

6.【强制】禁止大表使用JOIN查询，禁止大表使用子查询，JOIN 查询不超过3个。
说明：查询是会生成临时表，消耗较多内存和CPU，极大影响数据库性能，避免使用大表的join，建议使用小表驱动大表。

7.【强制】禁止使用前缀是%的like和负向查询。
说明：
(1)负向查询条件：NOT、!=、<>、!<、!>、NOT IN、NOT LIKE等，会导致全表扫描
(2)%开头的模糊查询，会导致全表扫描。

8.【强制】禁用 SELECT *，只获取必要的字段，需要显示说明列属性。
说明：
(1)读取不需要的列会增加CPU、IO、网络的消耗。
(2)不能有效的利用覆盖索引

9.【强制】禁止使用属性隐式转换。
说明：SELECT uid FROM t_user WHERE phone=13812345678会导致全表扫描，而不能命中phone索引。

10.【强制】禁止在WHERE条件的属性上使用函数或者表达式
说明：SELECT uid FROM t_user WHERE from_unixtime(day)>=’2017-02-15’会导致全表扫描
正确的写法是：SELECT uid FROM t_user WHERE day>= unix_timestamp(‘2017-02-15 00:00:00’)

11.【强制】OR 改成 IN，in的个数控制在200以内。
正例： SELECT a FROM t WHERE ID IN(1,2,3)
反例：SELECT a FROM t WHERE ID=1 OR ID=2 OR ID=3

12.【推荐】OR 改成UNION / UNION ALL。
正例：SELECT idFROM t WHERE phone = ’159′ UNIONSELECT idFROM t WHERE name = ‘john’;
反例：SELECT idFROM t WHERE phone = ’159′ or name = ‘john’;

13.【强制】变量/参数/关联字段类型必须与字段类型一致
说明：类型转换消耗CPU，引发全表扫描

14.【强制】LIMIT高效分页。
说明：limit越大，效率越低
正例：SELECT idFROM t WHERE id>100000 limit 10;
反例：SELECT idFROM t limit 100000, 10;

15.【强制】避免出现now()、rand()、sysdate()、current_user()等不确定结果的函数。
说明：语句级复制场景下，引起主从数据不一致；不确定值的函数，产生的SQL语句无法利用查询缓存。

16.【强制】对同一个表的多次alter操作必须合并为一次操作。

说明：mysql对表的修改绝大部分操作都需要锁表并重建表，而锁表则会对线上业务造成影响。为减少这种影响，必须把对表的多次alter操作合并
为一次操作。

17.【推荐】谨慎使用count，myisam引擎会比较快，但Innodb不会存储总行数，速度较慢，对于大表请谨慎使用。

18.【强制】在对结果集进行COUNT操作时 不要嵌套子查询

19.【强制】使用预编译语句（prepare statement），提高语句的解析效率，降低SQL注入概率

20.【推荐】养成良好编码习惯，Explain每一个写出的sql语句。
说明：重要的列至少要rang以上，避免extra列出现：Using File Sort，Using Temporary

21.【推荐】尽量避免在页面初次打开时 没有任何过滤条件的情况下产生分页查询

### 如何防范SQL注入

1、尽量使用预编译SQL语句：由于动态SQL语句是引发SQL注入的根源。应使用预编译语句来组装SQL查询。
正例：String sql = “select * from t_user where account = ? “;
反例：String sql = “select * from t_user where account=’”+account+”‘“;

## 【四、命名规范】

1.数据库对象简称+”_”+业务意义小写英文单词，多个单词之间用下划线连接，命名时不要用中文拼音；
(1)单词不要缩写(除非是被业界认可 并被普遍使用的)
(2) 不要使用复数形式的单词

2.数据库对象table / view / procedure / function / event / index 分别使用对象简称：

```php
 Table :t_
 View :v_
 Procedure :sp_
 Function :fun_
 Event :ev_
 Index :idx_(普通索引) uk_(唯一索引)
```

备份表命名: 运维同学在进行线上数据库操作时 如需对数据表进行临时备份 命名规则为在表名后加上当前日期(t_table_backup_20180322)

## 【五、生产环境数据改动规范】

1..【强制】对生产环境的数据改动SQL执行，必须经过SQL审计系统。由领导审核通过后方可执行
以附件形式上传 1.SQL.txt 2.回滚SQL.txt